{% extends 'base.html' %}

{% block title %}{{ page_title }}{% endblock %} {# page_title from context #}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css">
<style>
    #map {
        height: 500px;
        width: 100%;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    .filter-card {
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        background-color: white;
        padding: 1.5rem;
    }
    .opportunity-card {
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid #e9ecef;
        border-radius: 8px;
    }
    .opportunity-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }
    .opportunity-card.active {
        border: 2px solid #00A651;
        box-shadow: 0 6px 20px rgba(0, 166, 81, 0.2);
    }
    .comparison-table th {
        background-color: #f8f9fa;
    }
    .score-high { color: #00A651; font-weight: bold; }
    .score-medium { color: #FF9500; }
    .score-low { color: #FF3B30; }
    .range-slider { width: 100%; }
    #range-value { font-weight: 500; color: var(--bs-primary); }
    .list-view .opportunity-card { display: flex; flex-direction: row; align-items: center; }
    .list-view .opportunity-card img { width: 150px; height: auto; margin-right: 1rem; }
    .list-view .opportunity-card .card-body { flex-grow: 1; }
    :root { --bs-primary: #0d6efd; }
</style>
{% endblock %}

{% block content %}
<section class="bg-light py-5">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <h1 class="mb-3">{{ page_title }}</h1> {# page_title from context #}
                <p class="lead mb-4">Discover promising investment locations based on comprehensive urban data analysis, safety records, business potential, and environmental considerations.</p>
            </div>
        </div>
    </div>
</section>

<section class="py-5">
    <div class="container">
        <div class="row">
            <div class="col-lg-4 mb-4">
                <div class="filter-card">
                    <h4 class="mb-4">Search Filters</h4>
                    <div class="mb-3">
                        <label for="location" class="form-label">Location</label>
                        <select class="form-select" id="location">
                            <option value="all">All Locations</option>
                            <option value="downtown">Downtown</option>
                            <option value="north">North District</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="property-type" class="form-label">Property Type</label>
                        <select class="form-select" id="property-type">
                            <option value="all">All Types</option>
                            <option value="commercial">Commercial</option>
                            <option value="residential">Residential</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="investment-range" class="form-label">Investment Range</label>
                        <div class="d-flex align-items-center gap-2">
                            <span>$100K</span>
                            <input type="range" class="form-range range-slider" min="100000" max="10000000" step="100000" id="investment-range" value="1000000">
                            <span>$10M+</span>
                        </div>
                        <div class="text-center mt-1" id="range-value">$1,000,000</div>
                    </div>
                    <div class="mb-3">
                        <label for="safety-score" class="form-label">Safety Score (Minimum)</label>
                        <select class="form-select" id="safety-score">
                            <option value="1">Any Score</option>
                            <option value="3">3+ Stars</option>
                            <option value="5">5 Stars Only</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Sustainability Features</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="green-energy">
                            <label class="form-check-label" for="green-energy">Green Energy</label>
                        </div>
                    </div>
                    <button class="btn btn-primary w-100" id="apply-filters">Apply Filters</button>
                    <button class="btn btn-outline-secondary w-100 mt-2" id="reset-filters">Reset Filters</button>
                </div>
            </div>
            
            <div class="col-lg-8">
                <div class="card mb-4"><div class="card-body p-0"><div id="map"></div></div></div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">Results: <span id="results-count">{{ opportunities|length }}</span> properties</h4>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-secondary active" id="view-grid"><i class="bi bi-grid-fill"></i> Grid</button>
                        <button class="btn btn-sm btn-outline-secondary" id="view-list"><i class="bi bi-list-ul"></i> List</button>
                    </div>
                </div>
                
                <div class="row" id="results-container">
                    {% if opportunities %}
                        {% for opp in opportunities %}
                        <div class="col-md-6 mb-4 opportunity-item">
                            <div class="card h-100 opportunity-card" data-id="prop-{{ loop.index }}">
                                <img src="{{ STATIC_URL }}img/{{ opp.image_slug }}" class="card-img-top" alt="{{ opp.name }}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 class="card-title mb-0">{{ opp.name }}</h5>
                                        <span class="badge bg-primary">{{ opp.type }}</span>
                                    </div>
                                    <p class="card-text text-muted mb-2">{{ opp.address }}</p>
                                    <div class="mb-2">
                                        {% set score = opp.safety_score|float %} {# Ensure score is float for comparison #}
                                        {% for i in range(1, 6) %}
                                            <i class="bi {% if i <= score %}bi-star-fill{% elif i - 0.5 <= score %}bi-star-half{% else %}bi-star{% endif %} text-warning"></i>
                                        {% endfor %}
                                        <span class="ms-1 small">Safety Score ({{ opp.safety_score }}/5)</span>
                                    </div>
                                    <p class="card-text small">{{ opp.description }}</p>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <strong class="text-primary fs-5">{{ opp.price }}</strong>
                                        <button class="btn btn-sm btn-outline-primary compare-btn" data-id="prop-{{ loop.index }}">Compare</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="col-12"><p>No investment opportunities found matching your criteria.</p></div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>

<section class="py-5 bg-light" id="comparison-section" style="display: none;">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Property Comparison</h2>
            <button class="btn btn-outline-secondary" id="close-comparison"><i class="bi bi-x-lg"></i> Close</button>
        </div>
        <div class="card"><div class="card-body"><div class="table-responsive">
            <table class="table comparison-table table-striped">
                <thead><tr>
                    <th style="width: 20%;">Property</th>
                    <th id="prop-col-1-header" style="width: 26%;"></th>
                    <th id="prop-col-2-header" style="width: 26%;"></th>
                    <th id="prop-col-3-header" style="width: 26%;"></th>
                </tr></thead>
                <tbody id="comparison-table-body"></tbody>
            </table>
        </div></div></div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const mapElement = document.getElementById('map');
    let map;
    if (mapElement) {
        map = L.map('map').setView([40.7128, -74.0060], 13); // Default to New York
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
    }

    const propertyDataFromContext = {{ opportunities|tojson|safe if opportunities else [] }};
    const propertyDataStore = {};
    propertyDataFromContext.forEach(p => {
        propertyDataStore[p.id || `prop-${p.name.replace(/\s+/g, '-')}`] = p; // Create an ID if not present
        if (map && p.lat && p.lng) { // Check if lat/lng are present
             L.marker([p.lat, p.lng]).addTo(map).bindPopup(`<b>${p.name}</b><br>${p.price}`);
        }
    });
    
    // Add markers for any static properties if opportunities context is empty/different
    // This part might be redundant if context always provides 'opportunities'
    const staticProperties = [ // Only used if context.opportunities is empty
        { id: 'prop1-static', name: 'Downtown Office Building (Static)', lat: 40.7128, lng: -74.0060, type: 'Commercial', price: '$2,450,000', safety_score: 4.0, image_slug: 'property1.jpg', address: '123 Main St, Downtown', description: 'Modern office building...' },
        { id: 'prop2-static', name: 'East Side Mixed-Use (Static)', lat: 40.7200, lng: -73.9800, type: 'Mixed Use', price: '$3,750,000', safety_score: 4.5, image_slug: 'property2.jpg', address: '456 Park Ave, East Side', description: 'Newly renovated mixed-use...' }
    ];

    if (map && propertyDataFromContext.length === 0) { // Only add static if context is empty
        staticProperties.forEach(p => {
            propertyDataStore[p.id] = p; // Add to store for comparison
            if (p.lat && p.lng) {
                L.marker([p.lat, p.lng]).addTo(map).bindPopup(`<b>${p.name}</b><br>${p.price}`);
            }
        });
    }


    const rangeSlider = document.getElementById('investment-range');
    const rangeValueDisplay = document.getElementById('range-value');
    if (rangeSlider && rangeValueDisplay) {
        rangeSlider.addEventListener('input', function() {
            rangeValueDisplay.textContent = '$' + parseInt(this.value).toLocaleString();
        });
    }

    const compareButtons = document.querySelectorAll('.compare-btn');
    const comparisonSection = document.getElementById('comparison-section');
    const closeComparisonBtn = document.getElementById('close-comparison');
    const comparisonTableBody = document.getElementById('comparison-table-body');
    let selectedToCompareProperties = [];

    compareButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const propertyId = this.getAttribute('data-id'); // This will be prop-1, prop-2 etc.
            // We need to map this back to an actual property ID from our store if it's different.
            // For now, assuming the context-generated IDs are what we use.
            // If using static IDs from the JS array, a mapping might be needed if loop.index based IDs are used in HTML.
            
            // For simplicity, let's assume the button's data-id directly matches a key in propertyDataStore
            // This might need adjustment if the `data-id` from the template (prop-{{loop.index}}) doesn't match keys in propertyDataStore
            // (e.g. if propertyDataStore uses actual database IDs).
            // For now, we'll try to find a match based on the `opp.id` if available, or construct one.
            
            let actualPropertyId = propertyId; // Fallback
            // Try to find the actual ID from the rendered cards if possible
            const cardElement = this.closest('.opportunity-card');
            // This part is tricky without knowing the exact ID structure from context.
            // Let's assume for now the button's data-id is what we use.
            // If your `opp.id` is what you want to use, ensure it's in `data-id`.

            const propertyCard = document.querySelector(`.opportunity-card[data-id="${actualPropertyId}"]`);

            if (selectedToCompareProperties.includes(actualPropertyId)) {
                selectedToCompareProperties = selectedToCompareProperties.filter(id => id !== actualPropertyId);
                this.textContent = 'Compare';
                this.classList.remove('btn-danger'); this.classList.add('btn-outline-primary');
                if (propertyCard) propertyCard.classList.remove('active');
            } else {
                if (selectedToCompareProperties.length < 3) {
                    selectedToCompareProperties.push(actualPropertyId);
                    this.textContent = 'Remove';
                    this.classList.remove('btn-outline-primary'); this.classList.add('btn-danger');
                    if (propertyCard) propertyCard.classList.add('active');
                } else {
                    alert('You can compare up to 3 properties.'); return;
                }
            }
            if (comparisonSection) {
                comparisonSection.style.display = selectedToCompareProperties.length >= 1 ? 'block' : 'none';
                if(selectedToCompareProperties.length >= 1) updateComparisonTable();
            }
        });
    });

    if (closeComparisonBtn) {
        closeComparisonBtn.addEventListener('click', function() {
            if (comparisonSection) comparisonSection.style.display = 'none';
            selectedToCompareProperties = [];
            compareButtons.forEach(button => {
                button.textContent = 'Compare';
                button.classList.remove('btn-danger'); button.classList.add('btn-outline-primary');
            });
            document.querySelectorAll('.opportunity-card.active').forEach(card => card.classList.remove('active'));
        });
    }
    
    function updateComparisonTable() {
        if (!comparisonTableBody) return;
        comparisonTableBody.innerHTML = ''; 

        const headers = ['Name', 'Type', 'Price', 'Safety Score', 'Description', 'Action'];
        const dataKeys = ['name', 'type', 'price', 'safety_score', 'description'];

        for (let i = 0; i < 3; i++) {
            const colHeader = document.getElementById(`prop-col-${i+1}-header`);
            if (colHeader) {
                if (selectedToCompareProperties[i] && propertyDataStore[selectedToCompareProperties[i]]) {
                    colHeader.textContent = propertyDataStore[selectedToCompareProperties[i]].name;
                    colHeader.style.display = '';
                } else {
                    colHeader.textContent = ''; colHeader.style.display = 'none';
                }
            }
        }
        
        headers.forEach((headerText, rowIndex) => {
            const row = comparisonTableBody.insertRow();
            const headerCell = row.insertCell();
            headerCell.innerHTML = `<strong>${headerText}</strong>`;

            for (let i = 0; i < 3; i++) {
                const cell = row.insertCell();
                const propId = selectedToCompareProperties[i];
                if (propId && propertyDataStore[propId]) {
                    const propData = propertyDataStore[propId];
                    if (headerText === 'Action') {
                        cell.innerHTML = `<a href="#" class="btn btn-sm btn-primary">View Details</a>`;
                    } else {
                        cell.textContent = propData[dataKeys[rowIndex]] || 'N/A';
                    }
                    document.getElementById(`prop-col-${i+1}-header`).style.display = '';
                } else {
                    cell.textContent = '';
                    document.getElementById(`prop-col-${i+1}-header`).style.display = 'none';
                }
            }
        });
    }
    // ... rest of JS for view toggle and filters ...
});
</script>
{% endblock %}
