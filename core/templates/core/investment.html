{% extends 'base.html' %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css">
<style>
    #map { height: 500px; width: 100%; border-radius: 8px; border: 1px solid #dee2e6; }
    .filter-card { border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); background-color: white; padding: 1.5rem; }
    .opportunity-card { cursor: pointer; transition: all 0.3s ease; border: 1px solid #e9ecef; border-radius: 8px; }
    .opportunity-card:hover { transform: translateY(-5px); box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
    .opportunity-card.active { border: 2px solid #00A651; box-shadow: 0 6px 20px rgba(0,166,81,0.2); }
    /* Add other necessary styles from your original file if they were removed in previous versions I sent */
    :root { --bs-primary: #0d6efd; } /* Ensure bs-primary is defined */
</style>
{% endblock %}

{% block content %}
<section class="bg-light py-5">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <h1 class="mb-3">{{ page_title }}</h1> {# page_title from context #}
                <p class="lead mb-4">Discover promising investment locations based on comprehensive urban data analysis, safety records, business potential, and environmental considerations.</p>
            </div>
        </div>
    </div>
</section>

<section class="py-5">
    <div class="container">
        <div class="row">
            <div class="col-lg-4 mb-4">
                <div class="filter-card">
                    <h4 class="mb-4">Search Filters</h4>
                    <div class="mb-3">
                        <label for="location" class="form-label">Location</label>
                        <select class="form-select" id="location">
                            <option value="all">All Locations</option>
                            <option value="downtown">Downtown</option>
                            <option value="north">North District</option>
                        </select>
                    </div>
                    <button class="btn btn-primary w-100" id="apply-filters">Apply Filters</button>
                </div>
            </div>
            
            <div class="col-lg-8">
                <div class="card mb-4"><div class="card-body p-0"><div id="map"></div></div></div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">Results: <span id="results-count">{{ opportunities|length }}</span> properties</h4>
                </div>
                
                <div class="row" id="results-container">
                    {% if opportunities %}
                        {% for opp in opportunities %} {# 'opp' is the loop variable here #}
                        <div class="col-md-6 mb-4 opportunity-item">
                             {# Use opp.id or another unique property for data-id if needed by JS, avoid loop.index #}
                            <div class="card h-100 opportunity-card" data-property-id="{{ opp.id }}">
                                <img src="{{ STATIC_URL }}img/{{ opp.image_slug }}" class="card-img-top" alt="{{ opp.name }}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 class="card-title mb-0">{{ opp.name }}</h5>
                                        <span class="badge bg-primary">{{ opp.type }}</span>
                                    </div>
                                    <p class="card-text text-muted mb-2">{{ opp.address }}</p>
                                    <div class="mb-2">
                                        {% set score = opp.safety_score|float %} 
                                        {% for i in range(1, 6) %}
                                            <i class="bi {% if i <= score %}bi-star-fill{% elif i - 0.5 <= score %}bi-star-half{% else %}bi-star{% endif %} text-warning"></i>
                                        {% endfor %}
                                        <span class="ms-1 small">Safety Score ({{ opp.safety_score }}/5)</span>
                                    </div>
                                    <p class="card-text small">{{ opp.description }}</p>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <strong class="text-primary fs-5">{{ opp.price }}</strong>
                                        <button class="btn btn-sm btn-outline-primary compare-btn" data-compare-id="{{ opp.id }}">Compare</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="col-12"><p>No investment opportunities found.</p></div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const mapElement = document.getElementById('map');
    if (mapElement) {
        const map = L.map('map').setView([40.7128, -74.0060], 13); 
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // opportunities should be passed from Python context via tojson filter
        const opportunitiesData = {{ opportunities|tojson|safe if opportunities else [] }};
        
        opportunitiesData.forEach(function(opp) {
            if (opp.lat && opp.lng) { // Check if lat and lng are valid
                L.marker([opp.lat, opp.lng]).addTo(map)
                    .bindPopup('<b>' + opp.name + '</b><br />' + opp.price);
            }
        });
    }
    // console.log("Investment page JS loaded. Opportunities:", {{ opportunities|tojson|safe if opportunities else [] }});
});
</script>
{% endblock %}
