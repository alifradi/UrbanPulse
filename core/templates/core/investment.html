{% extends 'core/base.html' %}

{% block title %}{{ page_title|default:"Investment Opportunities - UrbanPulse" }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css">
<style>
    #map {
        height: 500px;
        width: 100%;
        border-radius: 8px;
        border: 1px solid #dee2e6; /* Added a light border */
    }
    .filter-card {
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); /* Softer shadow */
        background-color: white;
        padding: 1.5rem;
    }
    .opportunity-card {
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid #e9ecef; /* Default light border */
        border-radius: 8px; /* Consistent border radius */
    }
    .opportunity-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.1); /* Enhanced hover shadow */
    }
    .opportunity-card.active {
        border: 2px solid #00A651; /* Using a green similar to sustainability scores */
        box-shadow: 0 6px 20px rgba(0, 166, 81, 0.2);
    }
    .comparison-table th {
        background-color: #f8f9fa; /* Lighter gray for table headers */
    }
    .score-high {
        color: #00A651; /* Green for high scores */
        font-weight: bold;
    }
    .score-medium {
        color: #FF9500; /* Orange for medium scores */
    }
    .score-low {
        color: #FF3B30; /* Red for low scores */
    }
    .range-slider {
        width: 100%;
    }
    #range-value {
        font-weight: 500;
        color: var(--bs-primary);
    }
    .list-view .opportunity-card { /* Styles for list view if implemented */
        display: flex;
        flex-direction: row;
        align-items: center;
    }
    .list-view .opportunity-card img {
        width: 150px; /* Fixed width for image in list view */
        height: auto;
        margin-right: 1rem;
    }
     .list-view .opportunity-card .card-body {
        flex-grow: 1;
    }
</style>
{% endblock %}

{% block content %}
<section class="bg-light py-5">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <h1 class="mb-3">{{ page_title|default:"Investment Opportunities" }}</h1>
                <p class="lead mb-4">Discover promising investment locations based on comprehensive urban data analysis, safety records, business potential, and environmental considerations.</p>
            </div>
          </div>
    </div>
</section>

<section class="py-5">
    <div class="container">
        <div class="row">
            <div class="col-lg-4 mb-4">
                <div class="filter-card">
                    <h4 class="mb-4">Search Filters</h4>
                    
                    <div class="mb-3">
                        <label for="location" class="form-label">Location</label>
                        <select class="form-select" id="location">
                            <option value="all">All Locations</option>
                            <option value="downtown">Downtown</option>
                            <option value="north">North District</option>
                            <option value="east">East Side</option>
                            <option value="west">West End</option>
                            <option value="south">South Quarter</option>
                            <option value="industrial">Industrial Zone</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="property-type" class="form-label">Property Type</label>
                        <select class="form-select" id="property-type">
                            <option value="all">All Types</option>
                            <option value="commercial">Commercial</option>
                            <option value="residential">Residential</option>
                            <option value="mixed">Mixed Use</option>
                            <option value="industrial">Industrial</option>
                            <option value="land">Vacant Land</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="investment-range" class="form-label">Investment Range</label>
                        <div class="d-flex align-items-center gap-2">
                            <span>$100K</span>
                            <input type="range" class="form-range range-slider" min="100000" max="10000000" step="100000" id="investment-range" value="1000000">
                            <span>$10M+</span>
                        </div>
                        <div class="text-center mt-1" id="range-value">$1,000,000</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="safety-score" class="form-label">Safety Score (Minimum)</label>
                        <select class="form-select" id="safety-score">
                            <option value="1">Any Score</option>
                            <option value="2">2+ Stars</option>
                            <option value="3">3+ Stars</option>
                            <option value="4">4+ Stars</option>
                            <option value="5">5 Stars Only</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Sustainability Features</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="green-energy">
                            <label class="form-check-label" for="green-energy">Green Energy Installations</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="leed-certified">
                            <label class="form-check-label" for="leed-certified">LEED Certified</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="public-transport">
                            <label class="form-check-label" for="public-transport">Public Transport Access</label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="business-potential" class="form-label">Business Potential</label>
                        <select class="form-select" id="business-potential">
                            <option value="all">All Ratings</option>
                            <option value="high">High Potential</option>
                            <option value="medium">Medium Potential</option>
                            <option value="low">Low Potential</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-primary w-100" id="apply-filters">Apply Filters</button>
                    <button class="btn btn-outline-secondary w-100 mt-2" id="reset-filters">Reset Filters</button>
                </div>
            </div>
            
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-body p-0">
                        <div id="map"></div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">Results: <span id="results-count">6</span> properties</h4>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-secondary active" id="view-grid" aria-label="Grid view">
                            <i class="bi bi-grid-fill"></i> Grid
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" id="view-list" aria-label="List view">
                            <i class="bi bi-list-ul"></i> List
                        </button>
                    </div>
                </div>
                
                <div class="row" id="results-container">
                    {# Loop through opportunities from context if available #}
                    {% if opportunities %}
                        {% for opp in opportunities %}
                        <div class="col-md-6 mb-4 opportunity-item"> {# Add class for easier targeting #}
                            <div class="card h-100 opportunity-card" data-id="prop-{{ loop.index }}">
                                <img src="{{ STATIC_URL }}img/{{ opp.image_slug|default:'property_placeholder.jpg' }}" class="card-img-top" alt="{{ opp.name }}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 class="card-title mb-0">{{ opp.name }}</h5>
                                        <span class="badge bg-primary">{{ opp.type|default:"Commercial" }}</span>
                                    </div>
                                    <p class="card-text text-muted mb-2">{{ opp.address|default:"Address unavailable" }}</p>
                                    <div class="mb-2">
                                        {% for i in range(1, 6) %}
                                            <i class="bi {% if i <= (opp.safety_score|default(3)|int) %}bi-star-fill{% elif i - 0.5 <= (opp.safety_score|default(3)) %}bi-star-half{% else %}bi-star{% endif %} text-warning"></i>
                                        {% endfor %}
                                        <span class="ms-1 small">Safety Score ({{ opp.safety_score|default(3) }}/5)</span>
                                    </div>
                                    <p class="card-text small">{{ opp.description|default:"Property description." }}</p>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <strong class="text-primary fs-5">{{ opp.price|default:"$N/A" }}</strong>
                                        <button class="btn btn-sm btn-outline-primary compare-btn" data-id="prop-{{ loop.index }}">Compare</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="col-md-6 mb-4 opportunity-item">
                        <div class="card h-100 opportunity-card" data-id="prop1">
                            <img src="{{ STATIC_URL }}img/property1.jpg" class="card-img-top" alt="Downtown Office Building">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="card-title mb-0">Downtown Office Building</h5>
                                    <span class="badge bg-primary">Commercial</span>
                                </div>
                                <p class="card-text text-muted mb-2">123 Main St, Downtown</p>
                                <div class="mb-2">
                                    <i class="bi bi-star-fill text-warning"></i><i class="bi bi-star-fill text-warning"></i><i class="bi bi-star-fill text-warning"></i><i class="bi bi-star-fill text-warning"></i><i class="bi bi-star text-warning"></i>
                                    <span class="ms-1 small">Safety Score (4/5)</span>
                                </div>
                                <p class="card-text small">Modern office building with high occupancy rate and excellent transit access.</p>
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <strong class="text-primary fs-5">$2,450,000</strong>
                                    <button class="btn btn-sm btn-outline-primary compare-btn" data-id="prop1">Compare</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4 opportunity-item">
                        <div class="card h-100 opportunity-card" data-id="prop2">
                            <img src="{{ STATIC_URL }}img/property2.jpg" class="card-img-top" alt="East Side Mixed-Use Development">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="card-title mb-0">East Side Mixed-Use</h5>
                                    <span class="badge bg-success">Mixed Use</span>
                                </div>
                                <p class="card-text text-muted mb-2">456 Park Ave, East Side</p>
                                <div class="mb-2">
                                    <i class="bi bi-star-fill text-warning"></i><i class="bi bi-star-fill text-warning"></i><i class="bi bi-star-fill text-warning"></i><i class="bi bi-star-fill text-warning"></i><i class="bi bi-star-half text-warning"></i>
                                    <span class="ms-1 small">Safety Score (4.5/5)</span>
                                </div>
                                <p class="card-text small">Newly renovated mixed-use property with retail space and luxury apartments.</p>
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <strong class="text-primary fs-5">$3,750,000</strong>
                                    <button class="btn btn-sm btn-outline-primary compare-btn" data-id="prop2">Compare</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>

<section class="py-5 bg-light" id="comparison-section" style="display: none;">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Property Comparison</h2>
            <button class="btn btn-outline-secondary" id="close-comparison" aria-label="Close comparison">
                <i class="bi bi-x-lg"></i> Close
            </button>
        </div>
        
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table comparison-table table-striped"> {# Added table-striped for better readability #}
                        <thead>
                            <tr>
                                <th style="width: 20%;">Property</th>
                                <th id="prop-col-1-header" style="width: 26%;"></th>
                                <th id="prop-col-2-header" style="width: 26%;"></th>
                                <th id="prop-col-3-header" style="width: 26%;"></th>
                            </tr>
                        </thead>
                        <tbody id="comparison-table-body">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Initialize map
    const mapElement = document.getElementById('map');
    let map; // Declare map variable
    if (mapElement) {
        map = L.map('map').setView([40.7128, -74.0060], 13); // Example: New York
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
    }

    // Sample property data (replace with dynamic data from context if available)
    const properties = [
        { id: 'prop1', name: 'Downtown Office Building', lat: 40.7128, lng: -74.0060, type: 'Commercial', price: '$2,450,000', safety_score: 4.0, size: '25,000 sq ft', business_potential: 'High', roi_estimate: '18.5%', sustainability: 'LEED Gold, Solar', hazard_risk: 'Low', last_inspection: 'March 2025', image_slug: 'property1.jpg', address: '123 Main St, Downtown', description: 'Modern office building...' },
        { id: 'prop2', name: 'East Side Mixed-Use', lat: 40.7200, lng: -73.9800, type: 'Mixed Use', price: '$3,750,000', safety_score: 4.5, size: '42,000 sq ft', business_potential: 'High', roi_estimate: '22.3%', sustainability: 'LEED Silver, EV', hazard_risk: 'Low', last_inspection: 'January 2025', image_slug: 'property2.jpg', address: '456 Park Ave, East Side', description: 'Newly renovated mixed-use...' },
        { id: 'prop3', name: 'North District Residential', lat: 40.7300, lng: -74.0100, type: 'Residential', price: '$4,200,000', safety_score: 3.0, size: '30,000 sq ft', business_potential: 'Medium', roi_estimate: '15.0%', sustainability: 'Green Roof', hazard_risk: 'Medium', last_inspection: 'Feb 2025', image_slug: 'property3.jpg', address: '789 Oak St, North District', description: 'Multi-family residential complex...' },
        // Add other properties from your static example if needed
    ];
    const propertyDataStore = {};
    properties.forEach(p => propertyDataStore[p.id] = p);


    // Add markers to map
    if (map) {
        properties.forEach(property => {
            const marker = L.marker([property.lat, property.lng]).addTo(map);
            marker.bindPopup(`
                <strong>${property.name}</strong><br>
                Type: ${property.type}<br>
                Price: ${property.price}<br>
                Safety: ${property.safety_score}/5.0<br>
                <button class="btn btn-sm btn-primary mt-2" onclick="window.highlightPropertyFromMap('${property.id}')">View Details</button>
            `);
        });
    }
    
    window.highlightPropertyFromMap = function(propertyId) {
        const propertyCard = document.querySelector(`.opportunity-card[data-id="${propertyId}"]`);
        if (propertyCard) {
            propertyCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            propertyCard.classList.add('border-primary', 'shadow-lg'); // Temporary highlight
            setTimeout(() => {
                propertyCard.classList.remove('border-primary', 'shadow-lg');
            }, 2500);
        }
    };

    // Investment range slider
    const rangeSlider = document.getElementById('investment-range');
    const rangeValueDisplay = document.getElementById('range-value');
    if (rangeSlider && rangeValueDisplay) {
        rangeSlider.addEventListener('input', function() {
            const value = parseInt(this.value);
            rangeValueDisplay.textContent = '$' + value.toLocaleString();
        });
    }

    // Compare functionality
    const compareButtons = document.querySelectorAll('.compare-btn');
    const comparisonSection = document.getElementById('comparison-section');
    const closeComparisonBtn = document.getElementById('close-comparison');
    const comparisonTableBody = document.getElementById('comparison-table-body');
    let selectedToCompareProperties = [];

    compareButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const propertyId = this.getAttribute('data-id');
            const propertyCard = document.querySelector(`.opportunity-card[data-id="${propertyId}"]`);

            if (selectedToCompareProperties.includes(propertyId)) {
                selectedToCompareProperties = selectedToCompareProperties.filter(id => id !== propertyId);
                this.textContent = 'Compare';
                this.classList.remove('btn-danger');
                this.classList.add('btn-outline-primary');
                if (propertyCard) propertyCard.classList.remove('active');
            } else {
                if (selectedToCompareProperties.length < 3) {
                    selectedToCompareProperties.push(propertyId);
                    this.textContent = 'Remove';
                    this.classList.remove('btn-outline-primary');
                    this.classList.add('btn-danger');
                    if (propertyCard) propertyCard.classList.add('active');
                } else {
                    alert('You can compare up to 3 properties at a time.');
                    return;
                }
            }
            
            if (comparisonSection) {
                if (selectedToCompareProperties.length >= 1) { // Show if at least 1 is selected
                    comparisonSection.style.display = 'block';
                    updateComparisonTable();
                } else {
                    comparisonSection.style.display = 'none';
                }
            }
        });
    });

    if (closeComparisonBtn) {
        closeComparisonBtn.addEventListener('click', function() {
            if (comparisonSection) comparisonSection.style.display = 'none';
            selectedToCompareProperties = [];
            compareButtons.forEach(button => {
                button.textContent = 'Compare';
                button.classList.remove('btn-danger');
                button.classList.add('btn-outline-primary');
            });
            document.querySelectorAll('.opportunity-card.active').forEach(card => {
                card.classList.remove('active');
            });
        });
    }
    
    function updateComparisonTable() {
        if (!comparisonTableBody) return;
        comparisonTableBody.innerHTML = ''; // Clear existing rows

        const headers = ['Property Type', 'Price', 'Size', 'Safety Score', 'Business Potential', 'ROI Estimate (5yr)', 'Sustainability Features', 'Hazard Risk', 'Last Inspection', 'Action'];
        const dataKeys = ['type', 'price', 'size', 'safety_score', 'business_potential', 'roi_estimate', 'sustainability', 'hazard_risk', 'last_inspection'];

        // Update column headers with property names
        for (let i = 0; i < 3; i++) {
            const colHeader = document.getElementById(`prop-col-${i+1}-header`);
            if (colHeader) {
                if (selectedToCompareProperties[i] && propertyDataStore[selectedToCompareProperties[i]]) {
                    colHeader.textContent = propertyDataStore[selectedToCompareProperties[i]].name;
                    colHeader.style.display = '';
                } else {
                    colHeader.textContent = '';
                    colHeader.style.display = 'none'; // Hide if no property
                }
            }
        }
        
        headers.forEach((headerText, rowIndex) => {
            const row = comparisonTableBody.insertRow();
            const headerCell = row.insertCell();
            headerCell.innerHTML = `<strong>${headerText}</strong>`;

            for (let i = 0; i < 3; i++) {
                const cell = row.insertCell();
                if (selectedToCompareProperties[i]) {
                    const propId = selectedToCompareProperties[i];
                    const propData = propertyDataStore[propId];
                    if (propData) {
                        if (headerText === 'Action') {
                            cell.innerHTML = `<a href="#" class="btn btn-sm btn-primary" onclick="window.highlightPropertyFromMap('${propId}'); return false;">View Details</a>`;
                        } else {
                            let value = propData[dataKeys[rowIndex]] || 'N/A';
                            if (dataKeys[rowIndex] === 'safety_score') value += '/5.0';
                            cell.textContent = value;
                            // Add specific styling based on value if needed (e.g., for scores)
                            if (dataKeys[rowIndex] === 'business_potential') {
                                cell.className = `score-${value.toLowerCase()}`;
                            }
                        }
                    } else {
                        cell.textContent = 'N/A';
                    }
                     document.getElementById(`prop-col-${i+1}-header`).style.display = ''; // Ensure header is visible
                } else {
                    cell.textContent = ''; // Empty cell if no property for this column
                    document.getElementById(`prop-col-${i+1}-header`).style.display = 'none'; // Hide header
                }
            }
        });
    }

    // View toggle (grid/list)
    const viewGridBtn = document.getElementById('view-grid');
    const viewListBtn = document.getElementById('view-list');
    const resultsContainer = document.getElementById('results-container');

    if (viewGridBtn && viewListBtn && resultsContainer) {
        viewListBtn.addEventListener('click', function() {
            viewGridBtn.classList.remove('active');
            viewListBtn.classList.add('active');
            resultsContainer.classList.add('list-view');
            document.querySelectorAll('#results-container > .opportunity-item').forEach(col => {
                col.classList.remove('col-md-6');
                col.classList.add('col-12');
            });
        });

        viewGridBtn.addEventListener('click', function() {
            viewListBtn.classList.remove('active');
            viewGridBtn.classList.add('active');
            resultsContainer.classList.remove('list-view');
            document.querySelectorAll('#results-container > .opportunity-item').forEach(col => {
                col.classList.remove('col-12');
                col.classList.add('col-md-6');
            });
        });
    }
    
    // Filter buttons
    const applyFiltersBtn = document.getElementById('apply-filters');
    if (applyFiltersBtn) {
        applyFiltersBtn.addEventListener('click', function() {
            alert('Filters applied! This would typically update the results from the server.');
        });
    }
    const resetFiltersBtn = document.getElementById('reset-filters');
    if (resetFiltersBtn) {
        resetFiltersBtn.addEventListener('click', function() {
            // Reset form elements
            const locationEl = document.getElementById('location');
            if (locationEl) locationEl.value = 'all';
            // ... reset other filter elements ...
            if (rangeSlider && rangeValueDisplay) {
                 rangeSlider.value = 1000000;
                 rangeValueDisplay.textContent = '$1,000,000';
            }
            alert('Filters reset!');
        });
    }
});
</script>
{% endblock %}
